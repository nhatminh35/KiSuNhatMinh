<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ Firebase</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-analytics.js"></script>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


    <script src="functions.js"></script>
   

</head>
<body>
    <div class="font-main">
    <div class="background">
        <div class="body">    
            <div class="main">
            
            <h1 style="text-align:center;">WELCOM TO SMART HOME</h1>
            <h1 style="text-align:center;">B·∫£ng Thu Th·∫≠p D·ªØ Li·ªáu </h1>
     <div style="text-align: center; margin-top: 20px;">
        <a href="index.html" style="font-size: 24px;">üîô Quay v·ªÅ trang ch√≠nh</a>
      </div>
    <h2>Nhi·ªát ƒë·ªô: <span id="nhietdo">--</span>¬∞C | ƒê·ªô ·∫©m: <span id="doam">--</span>%</h2>
   
    <table id="dataTable">
        <thead>
            <tr>
                <th>STT</th>
                <th>Nhi·ªát ƒê·ªô (¬∞C)</th>
                <th>ƒê·ªô ·∫®m (%)</th>
                <th>Th·ªùi Gian</th>
            </tr>
        </thead>
        <tbody>
            <!-- D·ªØ li·ªáu s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t -->
        </tbody>
     </table>
        </div>
          </div>   
            </div>
           
            <div class="btn_trang2">
                <button id="downloadPDF" class="btn waves-effect waves-light" style="margin: 20px; font-size: 30px;">
                    T·∫£i PDF
                </button>
            </div>
            <div class="clear_storage">
                <button id="CLEAR_STORAGE" class="btn waves-effect waves-light" style="margin: 20px; font-size: 30px;">
                    CLEAR
                </button>
            </div>
            
        </div>
</div>

    <script>
      // C·∫•u h√¨nh Firebase
      const firebaseConfig = {
          apiKey: "AIzaSyDUYbFI63SZmYV9SAyj_MCZcduuisIqxxc",
          authDomain: "minhnode-1eacf.firebaseapp.com",
          databaseURL: "https://minhnode-1eacf-default-rtdb.firebaseio.com",
          projectId: "minhnode-1eacf",
          storageBucket: "minhnode-1eacf.firebasestorage.app",
          messagingSenderId: "1007786576866",
          appId: "1:1007786576866:web:0810872495a6184ae747bb",
          measurementId: "G-YF59ZNWLKC"
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
  
      let latestTemp = null;
      let dataList = JSON.parse(localStorage.getItem("dataList")) || [];
      // H√†m l·∫•y th·ªùi gian th·ª±c
      function getCurrentTime() {
          let time = new Date();
          let gio = String(time.getHours()).padStart(2, '0');
          let phut = String(time.getMinutes()).padStart(2, '0');
          let giay = String(time.getSeconds()).padStart(2, '0');
          return `${gio}:${phut}:${giay}`;
      }
  
      // L·∫Øng nghe nhi·ªát ƒë·ªô t·ª´ Firebase
      function saveTemperatureWithHumidity(nhietdo) {
          database.ref("/Sensor/humidity").once("value").then((snapshot) => {
              let doam = snapshot.val();
              document.getElementById("doam").innerText = doam;
              addRow(nhietdo, doam);
          });
      }
  
      function getFirebaseData() {
          database.ref("/Sensor/temperature").on("value", (snapshot) => {
              let nhietdo = snapshot.val();
              if (nhietdo !== null && nhietdo !== latestTemp) {
                  latestTemp = nhietdo;
                  document.getElementById("nhietdo").innerText = nhietdo;
                  saveTemperatureWithHumidity(nhietdo);
              }
          });
      }
      getFirebaseData();
           // Khi nhi·ªát ƒë·ªô thay ƒë·ªïi, l·∫•y ƒë·ªô ·∫©m hi·ªán t·∫°i v√† l∆∞u c·∫£ hai
 
    function loadData() {
    let table = document.getElementById("dataTable").getElementsByTagName('tbody')[0];
    table.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈© tr√™n b·∫£ng tr∆∞·ªõc khi t·∫£i l·∫°i

    dataList.forEach((data, index) => {
        let newRow = table.insertRow();
        let cell1 = newRow.insertCell(0);
        let cell2 = newRow.insertCell(1);
        let cell3 = newRow.insertCell(2);
        let cell4 = newRow.insertCell(3);

        cell1.innerHTML = index + 1;
        cell2.innerHTML = data.nhietdo;
        cell3.innerHTML = data.doam;
        cell4.innerHTML = data.time;
    });
}  
function addRow(nhietdo, doam) {
    let table = document.getElementById("dataTable").getElementsByTagName('tbody')[0];
    
    let currentTime = getCurrentTime(); // L·∫•y th·ªùi gian hi·ªán t·∫°i

    // Th√™m d·ªØ li·ªáu m·ªõi v√†o danh s√°ch
    dataList.push({ nhietdo, doam, time: currentTime });

    // Gi·ªØ t·ªëi ƒëa 30 ph·∫ßn t·ª≠
    if (dataList.length > 20) {
        dataList.shift(); // X√≥a ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n (c≈© nh·∫•t)
        //dataList = []; // X√≥a to√†n b·ªô ph·∫ßn t·ª≠ trong m·∫£ng
    }

    // C·∫≠p nh·∫≠t localStorage
    localStorage.setItem("dataList", JSON.stringify(dataList));

    // L√†m m·ªõi b·∫£ng d·ªØ li·ªáu
    loadData();
}

      let nhietdo = localStorage.getItem("nhietdo") || "--";
      let doam = localStorage.getItem("doam") || "--";

// Th√™m d·ªØ li·ªáu v√†o b·∫£ng khi t·∫£i trang
loadData();

// Gi·∫£ l·∫≠p c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi t·ª´ Firebase (th√™m d·ªØ li·ªáu test)

  </script>
  <script>
    document.getElementById("downloadPDF").addEventListener("click", function () {
        let element = document.querySelector(".background"); // Ch·ªçn ph·∫ßn c·∫ßn xu·∫•t PDF
        html2pdf()
            .set({
                margin: 10,
                filename: 'SmartHome_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            })
            .from(element)
            .save();
        });
            document.getElementById("CLEAR_STORAGE").addEventListener("click", function () {
               
                dataList = []; 
                localStorage.removeItem("dataList"); // X√≥a d·ªØ li·ªáu trong localStorage
                loadData();
                   
     
    });
    </script>
    

    <script>
        const alertSound = new Audio("mp3/coibaodong.mp3");
      
        function checkAlert() {
          const alertState = localStorage.getItem("tempAlarmE");
          if (alertState === "on") {
            if (alertSound.paused || alertSound.ended) {
              alertSound.currentTime = 0;
              alertSound.play();
            }
          } else {
            alertSound.pause();
            alertSound.currentTime = 0;
          }
        }
      
        setInterval(checkAlert, 50);
        // check image
        
      </script>
      